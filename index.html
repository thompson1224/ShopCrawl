<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>핫딜 크롤링 웹서비스</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f3f4f6;
        }
        .summary-modal {
            max-height: 80vh;
        }
        /* 로딩 스피너 스타일 */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 p-6 flex flex-col items-center min-h-screen">
    <div class="container mx-auto p-6 bg-white rounded-lg shadow-xl max-w-2xl w-full mt-10">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">최신 핫딜 정보</h1>
        <div id="hotdeal-list" class="space-y-4">
            <!-- 핫딜 항목이 여기에 동적으로 추가됩니다 -->
            <div class="p-4 text-center text-gray-500 bg-gray-50 rounded-lg">
                <span class="animate-pulse">핫딜 정보를 불러오는 중...</span>
            </div>
        </div>
    </div>

    <!-- 요약 내용을 보여줄 모달 -->
    <div id="summary-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-white rounded-lg shadow-2xl p-6 m-4 w-full max-w-lg summary-modal flex flex-col">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">핫딜 요약 ✨</h2>
            <div id="summary-content" class="overflow-y-auto mb-4 text-gray-700 leading-relaxed">
                <!-- 요약 내용이 여기에 표시됩니다 -->
            </div>
            <button onclick="closeModal()" class="w-full bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors duration-200">닫기</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const hotdealList = document.getElementById('hotdeal-list');
            const summaryModal = document.getElementById('summary-modal');
            const summaryContent = document.getElementById('summary-content');

            // API 키는 Canvas 환경에서 자동으로 제공됩니다.
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const closeModal = () => {
                summaryModal.classList.add('hidden');
            };
            
            window.closeModal = closeModal;

            const generateSummary = async (title) => {
                summaryContent.innerHTML = `
                    <div class="flex items-center justify-center space-x-2 text-blue-500">
                        <div class="spinner"></div>
                        <span>요약 생성 중...</span>
                    </div>
                `;
                summaryModal.classList.remove('hidden');

                const systemPrompt = "당신은 전문 핫딜 분석가입니다. 제공된 핫딜에 대해 간결하고 명확한 요약을 제공하세요. 상품명, 주요 특징, 할인 정보를 중심으로 요약하며, 친근하고 읽기 쉽게 작성해야 합니다.";
                const userQuery = `핫딜 제목: ${title}\n이 핫딜을 요약해주세요.`;

                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                };

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`API 요청 실패! 상태: ${response.status}`);
                    }

                    const result = await response.json();
                    const summary = result?.candidates?.[0]?.content?.parts?.[0]?.text || "요약 내용을 가져오지 못했습니다.";
                    summaryContent.innerHTML = `<p>${summary}</p>`;
                } catch (error) {
                    console.error("Gemini API 호출 오류:", error);
                    summaryContent.innerHTML = `<p class="text-red-500">요약 생성 중 오류가 발생했습니다: ${error.message}</p>`;
                }
            };

            const fetchHotDeals = async () => {
                // 이제 FastAPI 백엔드 서버에서 데이터를 가져옵니다.
                // FastAPI 서버가 5000 포트에서 실행 중이라고 가정합니다.
                const backendUrl = '/api/hotdeals';

                try {
                    const response = await fetch(backendUrl);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const deals = await response.json();
                    
                    hotdealList.innerHTML = '';

                    if (deals.length === 0) {
                        hotdealList.innerHTML = '<div class="p-4 text-center text-gray-500 bg-gray-50 rounded-lg">핫딜 정보가 없습니다.</div>';
                        return;
                    }
                    
                    deals.forEach(deal => {
                        const dealElement = document.createElement('div');
                        dealElement.className = 'flex items-center justify-between p-4 bg-gray-50 rounded-lg transition-colors duration-200';
                        
                        const linkElement = document.createElement('a');
                        linkElement.href = deal.link;
                        linkElement.target = '_blank';
                        linkElement.className = 'flex-grow text-lg font-semibold text-gray-800 hover:text-blue-600';
                        linkElement.textContent = deal.title;

                        const summaryButton = document.createElement('button');
                        summaryButton.className = 'ml-4 bg-blue-500 text-white font-bold py-1 px-3 rounded-lg hover:bg-blue-600 transition-colors duration-200 text-sm flex-shrink-0';
                        summaryButton.innerHTML = '✨ 요약 보기';
                        summaryButton.onclick = () => generateSummary(deal.title);
                        
                        dealElement.appendChild(linkElement);
                        dealElement.appendChild(summaryButton);
                        hotdealList.appendChild(dealElement);
                    });
                } catch (error) {
                    console.error('핫딜 정보를 가져오는 중 오류 발생:', error);
                    hotdealList.innerHTML = `<div class="p-4 text-center text-red-500 bg-red-50 rounded-lg">핫딜 정보를 가져오는 데 실패했습니다: ${error.message}<br>백엔드 서버가 실행 중인지 확인하세요.</div>`;
                }
            };

            fetchHotDeals();
        });
    </script>
</body>
</html>
